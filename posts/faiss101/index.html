<!doctype html><html lang=en data-theme><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>FAISS-IVFPQ - fgg blog</title>
<meta name=description content="

    
        #
    
    Plain and Simple: IndexFlatL2


Given a set of vectors, we can index them using Faiss — then using another vector (the query vector), we search for the most similar vectors within the index.
Now, Faiss not only allows us to build an index and search — but it also speeds up search times to ludicrous performance levels.

IndexFlatL2 measures the L2 (or Euclidean) distance between all given points between our
query vector, and the vectors loaded into the index. It’s simple, very accurate, but not
too fast.

Image credit: pinecone.io"><link rel=icon type=image/x-icon href=https://fgg100y.github.io/favicon.ico><link rel=apple-touch-icon-precomposed href=https://fgg100y.github.io/favicon.png><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><link rel=stylesheet href=https://fgg100y.github.io/css/style.min.b4d24af3f8cf20d1698a5b809c35d6912485c2ea8bee514632a7b387676076bd.css integrity="sha256-tNJK8/jPINFpiluAnDXWkSSFwuqL7lFGMqezh2dgdr0="><link rel=stylesheet href=https://fgg100y.github.io/css/style.min.31d1662db6dd546a5622c56e7095ebbe00b4974b957a58b42c47937a98a3a611.css integrity="sha256-MdFmLbbdVGpWIsVucJXrvgC0l0uVeli0LEeTepijphE="><link rel=stylesheet href=https://fgg100y.github.io/css/style.min.159579eb91bf655c726d836d5df3d31b773597682769d2ccf74f0ce820296522.css integrity="sha256-FZV565G/ZVxybYNtXfPTG3c1l2gnadLM908M6CApZSI="><script src=https://fgg100y.github.io/js/script.min.74bf1a3fcf1af396efa4acf3e660e876b61a2153ab9cbe1893ac24ea6d4f94ee.js type=text/javascript integrity="sha256-dL8aP88a85bvpKzz5mDodrYaIVOrnL4Yk6wk6m1PlO4="></script></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><div class=header-top><div class=header-top-left><h1 class="site-title noselect"><a href=/>fgg blog</a></h1><div class=theme-switcher><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun-high" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14.828 14.828A4 4 0 109.172 9.172a4 4 0 005.656 5.656z"/><path d="M6.343 17.657l-1.414 1.414"/><path d="M6.343 6.343 4.929 4.929"/><path d="M17.657 6.343l1.414-1.414"/><path d="M17.657 17.657l1.414 1.414"/><path d="M4 12H2"/><path d="M12 4V2"/><path d="M20 12h2"/><path d="M12 20v2"/></svg></span></div><script>const STORAGE_KEY="user-color-scheme",defaultTheme="auto";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeGiscusTheme(currentTheme)};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme==="auto"?(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)):document.documentElement.setAttribute("data-theme",currentTheme),switchButton&&switchButton.addEventListener("click",switchTheme,!1),showContent()});function detectCurrentScheme(){return localStorage!==null&&localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function switchTheme(){currentTheme=currentTheme==="dark"?"light":"dark",localStorage&&localStorage.setItem(STORAGE_KEY,currentTheme),document.documentElement.setAttribute("data-theme",currentTheme),changeGiscusTheme(currentTheme)}function showContent(){document.body.style.visibility="visible",document.body.style.opacity=1}function changeGiscusTheme(e){function t(e){const t=document.querySelector("iframe.giscus-frame");if(!t)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}t({setConfig:{theme:e}})}</script><ul class=social-icons><li><a href=https://github.com/fgg100y title=Github rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></span></a></li><li><a href=https://fgg100y.github.io/index.xml title=RSS rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 19m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></span></a></li></ul></div><div class=header-top-right></div></div><nav class=noselect><a href=https://fgg100y.github.io/ title>Home</a>
<a href=https://fgg100y.github.io/posts/ title>Posts</a>
<a href=https://fgg100y.github.io/tags/ title>Tags</a>
<a href=https://fgg100y.github.io/about/ title>About</a></nav><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">FAISS-IVFPQ</h1></header><div class="post-info noselect"><div class="post-date dt-published"><time datetime=2024-05-22>2024-05-22</time></div><a class="post-hidden-url u-url" href=https://fgg100y.github.io/posts/faiss101/>https://fgg100y.github.io/posts/faiss101/</a>
<a href=https://fgg100y.github.io/ class="p-name p-author post-hidden-author h-card" rel=me>fmh</a><div class=post-taxonomies><ul class=post-tags><li><a href=https://fgg100y.github.io/tags/faiss/>#FAISS</a></li><li><a href=https://fgg100y.github.io/tags/ivf/>#IVF</a></li><li><a href>#乘积量化</a></li></ul></div></div></div><details class="toc noselect"><summary>Table of Contents</summary><div class=inner><nav id=TableOfContents><ul><li><a href=#plain-and-simple-indexflatl2>Plain and Simple: IndexFlatL2</a></li><li><a href=#inerted-file-index-ivf-index>Inerted File Index (IVF) index</a></li><li><a href=#product-quantization>Product Quantization</a></li><li><a href=#show-me-the-code>Show me the code</a></li><li><a href=#example-01-平凡的世界>Example 01: 平凡的世界</a></li><li><a href=#example-02-平凡的世界>Example 02: 平凡的世界</a></li><li><a href=#indexrange_search>index.range_search()</a></li></ul></nav></div></details><script>var toc=document.querySelector(".toc");toc&&toc.addEventListener("click",function(){event.target.tagName!=="A"&&(event.preventDefault(),this.open?(this.open=!1,this.classList.remove("expanded")):(this.open=!0,this.classList.add("expanded")))})</script><div class="content e-content"><h2 id=plain-and-simple-indexflatl2><div><a href=#plain-and-simple-indexflatl2>#
</a>Plain and Simple: IndexFlatL2</div></h2><blockquote><p>Given a set of vectors, we can index them using Faiss — then using another vector (the query vector), we search for the most similar vectors within the index.
Now, Faiss not only allows us to build an index and search — but it also speeds up search times to ludicrous performance levels.</p></blockquote><p>IndexFlatL2 measures the L2 (or Euclidean) distance between all given points between our
query vector, and the vectors loaded into the index. It’s simple, very accurate, but not
too fast.</p><p><img alt=IMG:indexFlat2 src=/posts/faiss101/images/faiss-IndexFlat2.webp>
<em><p style=text-align:center>Image credit: <a href=https://www.pinecone.io/learn/series/faiss/faiss-tutorial/>pinecone.io</a></p></em></p><ul><li>IndexFlatL2: simple but not scalable</li><li>Partitioning the index: for speed when scale up</li><li>Quantization: for more speed</li></ul><p><img alt="IMG:index&rsquo;s performance" src=/posts/faiss101/images/faiss-three-indexes-performance.webp>
<em><p style=text-align:center>Image credit: <a href=https://www.pinecone.io/learn/series/faiss/faiss-tutorial/>pinecone.io</a></p></em></p><h2 id=inerted-file-index-ivf-index><div><a href=#inerted-file-index-ivf-index>#
</a>Inerted File Index (IVF) index</div></h2><p>The Inverted File Index (IVF) index consists of search scope reduction through clustering.</p><blockquote><p>Inverted File Index (IVF) The IVF is simply a technique for pre-filtering the dataset so that you don’t have to do an exhaustive search of all of the vectors. It’s pretty straightforward–you cluster the dataset ahead of time with k-means clustering to produce a large number (e.g., 100) of dataset partitions. Then, at query time, you compare your query vector to the partition centroids to find, e.g., the 10 closest clusters, and then you search against only the vectors in those partitions.</p></blockquote><p>Partitioning the index (clustering)</p><blockquote><p>Faiss allows us to add multiple steps that can optimize our search using many different methods. A popular approach is to partition the index into Voronoi cells.
We can imagine our vectors as each being contained within a Voronoi cell — when we introduce a new query vector, we first measure its distance between centroids, then restrict our search scope to that centroid’s cell.
But there is a problem if our query vector lands near the edge of a cell — there’s a good chance that its closest other datapoint is contained within a neighboring cell.</p></blockquote><p>what we can do to mitigate this issue and increase search-quality is increase an index parameter known as the nprobe value. With nprobe we can set the number of cells to search. I.e., Increasing nprobe increases our search scope.</p><p><img alt="IMG:index particion" src=/posts/faiss101/images/faiss-voronoi-cells.webp>
<em><p style=text-align:center>Image credit: <a href=https://www.pinecone.io/learn/series/faiss/faiss-tutorial/>pinecone.io</a></p></em></p><p>进行聚类的结果，一方面可以极大提升查询速度，但另一方面，可能会造成落在聚类簇边缘的“query向量”只在本聚类簇内查找匹配的结果（实际上，它可能与邻近的聚类簇的其他向量更靠近），从而导致匹配质量的降低。
一个缓解这个问题的方法是：调整参数 nprobe. 通过增加 nprobe (增加用于匹配查询向量的邻近聚类簇数量）来提升匹配质量。（同时，也会增加查询耗时）</p><p><img alt="IMG:index particion" src=/posts/faiss101/images/faiss-voronoi-cells-search-scope.webp>
<em><p style=text-align:center>Image credit: <a href=https://www.pinecone.io/learn/series/faiss/faiss-tutorial/>pinecone.io</a></p></em></p><h2 id=product-quantization><div><a href=#product-quantization>#
</a>Product Quantization</div></h2><blockquote><p>All of our indexes so far have stored our vectors as full (eg Flat) vectors. Now, in very large datasets this can quickly become a problem.
Fortunately, Faiss comes with the ability to compress our vectors using Product Quantization (PQ).
But, what is PQ? Well, we can view it as an additional approximation step with a similar outcome to our use of IVF. Where IVF allowed us to approximate by reducing the scope of our search, PQ approximates the distance/similarity calculation instead.
PQ achieves this approximated similarity operation by compressing the vectors themselves, which consists of three steps.</p></blockquote><ol><li>Original vector</li><li>Sliced sub-vector</li><li>slice clustering</li><li>centroid ID vector</li></ol><p>PQ（乘积量化）不是对嵌入向量空间进行降维，而是对向量本身进行压缩：</p><ul><li>01 向量分段，例如：1024 -> 128x8 (8个片段)；</li><li>02 如果数据量是50k，则从单个50k x 1024 的矩阵，变成 8个 50k x 128 的矩阵；</li><li>03 然后分别用k=256的k-means进行聚类，得到8组256个centroids；则每个原始向量可以用长度为8的向量进行表征（8组与各个向量片段最近的centroid的ID）；</li><li>04 查询向量（query）同样进行片段化，并找到各组的centroids，然后计算片段向量与centroid的距离，并保存为距离表（partial query subvector-to-centroid distances table)；</li><li>05 查询向量与数据向量的距离？将数据向量的centroid-ID向量，用于 partial-query-distance-table 的表查询（table lookup），就能得到对应的一系列距离，然后计算其总和L2距离；</li><li>06 将查询向量与所有数据向量的距离计算出来，排序，即可得到 top-k 最近距离，亦即 top-k 最近似结果 （实际就是 KNN 算法）。</li><li>07 进一步的优化查询耗时，就是在计算距离的时候，不是对所有数据向量，而是只针对局部数据向量进行计算（也就是 IVF + PQ）。</li></ul><p><img alt="IMG:index particion" src=/posts/faiss101/images/faiss-three-steps-of-PQ.webp>
<em><p style=text-align:center>Image credit: <a href=https://www.pinecone.io/learn/series/faiss/faiss-tutorial/>pinecone.io</a></p></em></p><h2 id=show-me-the-code><div><a href=#show-me-the-code>#
</a>Show me the code</div></h2><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 0
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style=background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span></span><span style=background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style=background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff6ac1>import</span> faiss  <span style=color:#78787e># here&#39;s the &#39;faiss-cpu&#39; package actually</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>m <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>8</span>  <span style=color:#78787e># number of centroid IDs in final compressed vectors</span>
</span></span><span style=display:flex><span>bits <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>8</span> <span style=color:#78787e># number of bits in each centroid</span>
</span></span><span style=display:flex><span>nlist <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>50</span>  <span style=color:#78787e># how many cells/blocks</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># we keep the same L2 distance flat index</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>quantizer <span style=color:#ff6ac1>=</span> faiss<span style=color:#ff6ac1>.</span>IndexFlatL2(d)
</span></span><span style=display:flex;background-color:#3d3f4a><span>index <span style=color:#ff6ac1>=</span> faiss<span style=color:#ff6ac1>.</span>IndexIVFPQ(quantizer, d, nlist, m, bits)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># sentence_embeddings:</span>
</span></span><span style=display:flex><span><span style=color:#78787e># the target embeddings data from embedding model such as BERT/RoBERTa (or sentence-transformers)</span>
</span></span><span style=display:flex><span>index<span style=color:#ff6ac1>.</span>train(sentence_embeddings)
</span></span><span style=display:flex><span>index<span style=color:#ff6ac1>.</span>add(sentence_embeddings)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>index<span style=color:#ff6ac1>.</span>nprobe <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>10</span>  <span style=color:#78787e># see the &#34;IVF&#34; part mention before</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># xq: the query text</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>D, I <span style=color:#ff6ac1>=</span> index<span style=color:#ff6ac1>.</span>search(xq, k)  <span style=color:#78787e># searching top-k most similar vectors</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>for</span> i <span style=color:#ff6ac1>in</span> I<span style=color:#ff6ac1>.</span>tolist()[<span style=color:#ff9f43>0</span>]:
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>print</span>(indata[i])  <span style=color:#78787e># indata: sample of original texts/sentences</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=example-01-平凡的世界><div><a href=#example-01-%e5%b9%b3%e5%87%a1%e7%9a%84%e4%b8%96%e7%95%8c>#
</a>Example 01: 平凡的世界</div></h2><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">0
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style=background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></span><span style=background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python data-lang=python><span style=display:flex><span>d <span style=color:#ff6ac1>=</span> sent_embeddings<span style=color:#ff6ac1>.</span>shape[<span style=color:#ff9f43>1</span>]
</span></span><span style=display:flex><span>nlist <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>50</span>  <span style=color:#78787e># how many cells</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>quantizer <span style=color:#ff6ac1>=</span> faiss<span style=color:#ff6ac1>.</span>IndexFlatL2(d)
</span></span><span style=display:flex;background-color:#3d3f4a><span>index <span style=color:#ff6ac1>=</span> faiss<span style=color:#ff6ac1>.</span>IndexIVFFlat(quantizer, d, nlist)
</span></span><span style=display:flex><span>k <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>4</span>
</span></span><span style=display:flex><span>xq <span style=color:#ff6ac1>=</span> embedding_model<span style=color:#ff6ac1>.</span>encode([<span style=color:#5af78e>&#34;秀莲的老家在哪里？&#34;</span>])
</span></span><span style=display:flex><span>D, I <span style=color:#ff6ac1>=</span> index<span style=color:#ff6ac1>.</span>search(xq, k)
</span></span><span style=display:flex><span><span style=color:#ff6ac1>for</span> i <span style=color:#ff6ac1>in</span> I<span style=color:#ff6ac1>.</span>tolist()[<span style=color:#ff9f43>0</span>]:
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>print</span>(indata[i])
</span></span></code></pre></td></tr></table></div></div><pre><code>01 她干脆给家里人说：周围没她看上的男人！她姐夫对她开玩笑说：“那到外地给你瞅个女婿！”她却认真地说：“只要有合心的，山南海北我都愿意去！爸爸暂时有你们照顾，将来我再把他接走……”家里人吃惊之余，又看她这样认真，就向他们所有在门外的亲戚和熟人委托，让这些人给他们的秀莲在外地寻个对象……本来秀莲只是随便这么说说；她并没指望真能在外地找个合适的男人。

02 这家不能分！你也不要担心秀莲会怎样，总有我哩！”“你千万不要怪罪秀莲！秀莲实在是个好娃娃！人家从山西过来，不嫌咱家穷，几年来和一大家人搅在一起。

03 秀莲有时就体贴地坐在她身边，给她背上搔痒痒，或者把她的几绺稀疏的白发理顺，在脑后挽成核桃大一个大发髻，老太太不时用她的瘦手，满怀深情地在秀莲身上抚摸着。

04 直到寒露过了十来天，贺耀宗从山西心焦地写信问秀莲怎还不回来？是不是病了？秀莲这才决定动身回家去。
</code></pre><h2 id=example-02-平凡的世界><div><a href=#example-02-%e5%b9%b3%e5%87%a1%e7%9a%84%e4%b8%96%e7%95%8c>#
</a>Example 02: 平凡的世界</div></h2><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 0
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style=background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span></span><span style=background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python data-lang=python><span style=display:flex><span>d <span style=color:#ff6ac1>=</span> sent_embeddings<span style=color:#ff6ac1>.</span>shape[<span style=color:#ff9f43>1</span>]  <span style=color:#78787e># embedding&#39;s dimension</span>
</span></span><span style=display:flex><span>m <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>8</span>  <span style=color:#78787e># number of centroid IDs in final compressed vectors</span>
</span></span><span style=display:flex><span>bits <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>8</span> <span style=color:#78787e># number of bits in each centroid</span>
</span></span><span style=display:flex><span>nlist <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>50</span>  <span style=color:#78787e># how many cells/blocks</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>quantizer <span style=color:#ff6ac1>=</span> faiss<span style=color:#ff6ac1>.</span>IndexFlatL2(d)
</span></span><span style=display:flex;background-color:#3d3f4a><span>index <span style=color:#ff6ac1>=</span> faiss<span style=color:#ff6ac1>.</span>IndexIVFPQ(quantizer, d, nlist, m, bits)
</span></span><span style=display:flex><span>k <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>4</span>
</span></span><span style=display:flex><span>xq <span style=color:#ff6ac1>=</span> embedding_model<span style=color:#ff6ac1>.</span>encode([<span style=color:#5af78e>&#34;秀莲的老家在哪里？&#34;</span>])
</span></span><span style=display:flex><span>D, I <span style=color:#ff6ac1>=</span> index<span style=color:#ff6ac1>.</span>search(xq, k)
</span></span><span style=display:flex><span><span style=color:#ff6ac1>for</span> i <span style=color:#ff6ac1>in</span> I<span style=color:#ff6ac1>.</span>tolist()[<span style=color:#ff9f43>0</span>]:
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>print</span>(indata[i])
</span></span></code></pre></td></tr></table></div></div><pre><code>01 “如果把家分开，咱就是烧砖也能捎带种了自己的地！就是顾不上种地，把地荒了又怎样？咱拿钱买粮吃！三口人一年能吃多少？”其实，这话才是秀莲要表达的最本质的意思。

02 分家其实很简单，只是宣布今后他们将在经济上实行“独立核算”，原来的家产少安什么也没要，只是秀莲到新修建起的地方另起炉灶过日月罢了。

03 秀莲五岁上失去母亲以后，一直是她父亲把她和她姐秀英拉扯大的。

04 她干脆给家里人说：周围没她看上的男人！她姐夫对她开玩笑说：“那到外地给你瞅个女婿！”她却认真地说：“只要有合心的，山南海北我都愿意去！爸爸暂时有你们照顾，将来我再把他接走……”家里人吃惊之余，又看她这样认真，就向他们所有在门外的亲戚和熟人委托，让这些人给他们的秀莲在外地寻个对象……本来秀莲只是随便这么说说；她并没指望真能在外地找个合适的男人。
</code></pre><p>单从这两个例子对比着看，个人感觉 <code>indexIVFFlat()</code> 的检索结果 (Example 01) 要优于 <code>indexIVFPQ()</code> 的检索结果 (Example 02)。</p><p>怎么简单的方法效果比高明的算法要好？这不对吧？这里其实是想说明一个观点：理论上的“较优”，通常都要针对一个广泛的统计结果而言。而这里只有两个例子，不能说明问题！</p><h2 id=indexrange_search><div><a href=#indexrange_search>#
</a>index.range_search()</div></h2><p>The method range_search returns <strong>all vectors within a radius around the query point</strong> (as opposed to the k nearest ones). Since the result lists for each query are of different sizes, it must be handled specially:</p><pre><code>in C++ it returns the results in a pre-allocated RangeSearchResult structure

in Python, the results are returned as a triplet of 1D arrays lims, D, I, where result for query i is in I[lims[i]:lims[i+1]] (indices of neighbors), D[lims[i]:lims[i+1]] (distances).
</code></pre><p>Supported by (CPU only): IndexFlat, IndexIVFFlat, IndexScalarQuantizer, IndexIVFScalarQuantizer.</p><p>from <a href=https://github.com/facebookresearch/faiss/wiki/Special-operations-on-indexes#range-search>official doc</a></p><p>NOTE that this may not be the latest info.</p><p>Example code block:</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 0
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style=background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span></span><span style=background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># read the text data, and get the embeddings:</span>
</span></span><span style=display:flex><span><span style=color:#78787e>#texts_data = pd.Series(...)</span>
</span></span><span style=display:flex><span><span style=color:#78787e>#sentence_embeddings = embedding_model.encode(texts_data.values)</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>
</span></span><span style=display:flex><span><span style=color:#78787e># First, you need to use an index that supports Inner Product as metric, for example :</span>
</span></span><span style=display:flex><span>d <span style=color:#ff6ac1>=</span> sentence_embeddings<span style=color:#ff6ac1>.</span>shape[<span style=color:#ff9f43>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nlist <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>10</span>  <span style=color:#78787e># how many voronoi cells</span>
</span></span><span style=display:flex><span>quantizer <span style=color:#ff6ac1>=</span> faiss<span style=color:#ff6ac1>.</span>IndexFlatL2(d)
</span></span><span style=display:flex><span>index <span style=color:#ff6ac1>=</span> faiss<span style=color:#ff6ac1>.</span>IndexIVFFlat(quantizer, d, nlist)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>index<span style=color:#ff6ac1>.</span>train(sentence_embeddings)
</span></span><span style=display:flex><span>index<span style=color:#ff6ac1>.</span>add(sentence_embeddings)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>query <span style=color:#ff6ac1>=</span> [<span style=color:#5af78e>&#34;there and back again&#34;</span>, <span style=color:#5af78e>&#34;a hobbit&#39;s journey&#34;</span>]
</span></span><span style=display:flex><span>xq <span style=color:#ff6ac1>=</span> embedding_model<span style=color:#ff6ac1>.</span>encode(query)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Then, you should probably normalize all embeddings first</span>
</span></span><span style=display:flex><span><span style=color:#78787e># ( the inner product between two normalized embeddings corresponds to their cosine similarity )</span>
</span></span><span style=display:flex><span><span style=color:#78787e># https://github.com/facebookresearch/faiss/blob/master/python/faiss.py#L673</span>
</span></span><span style=display:flex><span>faiss<span style=color:#ff6ac1>.</span>normalize_L2(x<span style=color:#ff6ac1>=</span>sentence_embeddings)
</span></span><span style=display:flex><span>faiss<span style=color:#ff6ac1>.</span>normalize_L2(x<span style=color:#ff6ac1>=</span>xq)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>threshold <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>0.95</span>
</span></span><span style=display:flex><span>lims, D, I <span style=color:#ff6ac1>=</span> index<span style=color:#ff6ac1>.</span>range_search(x<span style=color:#ff6ac1>=</span>xq, thresh<span style=color:#ff6ac1>=</span>threshold)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># turn search results into dataframes</span>
</span></span><span style=display:flex><span>dfresults <span style=color:#ff6ac1>=</span> []
</span></span><span style=display:flex><span><span style=color:#ff6ac1>for</span> i <span style=color:#ff6ac1>in</span> <span style=color:#ff5c57>range</span>(<span style=color:#ff5c57>len</span>(xq)):
</span></span><span style=display:flex><span>    Ii <span style=color:#ff6ac1>=</span> I[lims[i]:lims[i<span style=color:#ff6ac1>+</span><span style=color:#ff9f43>1</span>]]
</span></span><span style=display:flex><span>    Di <span style=color:#ff6ac1>=</span> D[lims[i]:lims[i<span style=color:#ff6ac1>+</span><span style=color:#ff9f43>1</span>]]
</span></span><span style=display:flex><span>    dfout <span style=color:#ff6ac1>=</span> pd<span style=color:#ff6ac1>.</span>concat([texts_data[Ii], pd<span style=color:#ff6ac1>.</span>Series(Di, index<span style=color:#ff6ac1>=</span>Ii)], axis<span style=color:#ff6ac1>=</span><span style=color:#ff9f43>1</span>)
</span></span><span style=display:flex><span>    dfout<span style=color:#ff6ac1>.</span>columns <span style=color:#ff6ac1>=</span> [<span style=color:#5af78e>&#34;texts&#34;</span>, <span style=color:#5af78e>&#34;distances&#34;</span>]
</span></span><span style=display:flex><span>    dfresults<span style=color:#ff6ac1>.</span>append(dfout)
</span></span></code></pre></td></tr></table></div></div></div></article><div class="pagination post-pagination"><div class="left pagination-item"><a href=/posts/llm_prompt/>GPT-PROMPT</a></div><div class="right pagination-item"><a href=/posts/notes4resume/>tech interview prepare (for my resume)</a></div></div></main><footer class="common-footer noselect"><div class=common-footer-bottom><div style=display:flex;align-items:center;gap:8px>© fmh, 2024</div><div>Powered by <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, theme <a target=_blank rel="noopener noreferrer" href=https://github.com/Junyi-99/hugo-theme-anubis2>Anubis2</a>.<br></div></div><p class="h-card vcard"><a href=https://fgg100y.github.io/ class="p-name u-url url fn" rel=me>fmh</a></p></footer></div></body></html>